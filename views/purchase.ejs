<!-- add header -->
<%- include('includes/_header') %>
<!-- end header -->

<!-- Main section -->
<main id="main">
  <h2>Calculate Drugs to Purchase</h2>

  <p>For how many days do you want to purchase drugs?</p>
  <form id="drug_days">
    <input type="number" id="days" value="30" min="1" max="365">
    <button type="submit">Enter</button>
  </form>

  <table id="purchase_table">
    <thead>
      <tr>
        <th>#</th>
        <th>Drug Name</th>
        <th>Cards to Buy</th>
        <th>Packs to Buy</th>
      </tr>
    </thead>
    <tbody id="purchase_body">
      <% if (drugs && drugs.length > 0) { %>
        <% let days = 30; %>
        <% for (let i = 0; i < drugs.length; i++) { %>
          <% let pills = days * drugs[i].perDay; %>
          <tr>
            <td><%= i + 1 %></td>
            <td><%= drugs[i].name %></td>
            <td>
              <%= Math.ceil(pills / drugs[i].card) %> 
              (<%= drugs[i].pack / drugs[i].card %> 
              <% if (drugs[i].pack / drugs[i].card < 2) { %> card <% } else { %> cards <% } %> per pack)
            </td>
            <td><%= Math.ceil(pills / drugs[i].pack) %></td>
          </tr>
        <% } %>
      <% } else { %>
        <tr>
          <td colspan="4" style="text-align:center;">No drugs found</td>
        </tr>
      <% } %>
    </tbody>
  </table>

  <!-- gắn dữ liệu thuốc vào thẻ ẩn -->
  <div id="drugs-data" data-drugs='<%- JSON.stringify(drugs) %>'></div>
</main>
<!-- End main section -->

<!-- Script to handle dynamic day input -->
<script>
  document.getElementById("drug_days").addEventListener("submit", function(e) {
    e.preventDefault();
    const days = parseInt(document.getElementById("days").value) || 30;

    // Lấy dữ liệu thuốc từ attribute data-drugs
    const drugs = JSON.parse(document.getElementById("drugs-data").dataset.drugs);
    const tbody = document.getElementById("purchase_body");
    tbody.innerHTML = ""; // clear bảng cũ

    drugs.forEach((drug, i) => {
      const pills = days * drug.perDay;
      const cards = Math.ceil(pills / drug.card);
      const packs = Math.ceil(pills / drug.pack);

      const cardInfo = `${cards} (${drug.pack / drug.card} ${(drug.pack / drug.card < 2) ? 'card' : 'cards'} per pack)`;

      const row = `
        <tr>
          <td>${i + 1}</td>
          <td>${drug.name}</td>
          <td>${cardInfo}</td>
          <td>${packs}</td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", row);
    });
  });
</script>

<!-- add footer -->
<%- include('includes/_footer') %>
<!-- end footer -->
